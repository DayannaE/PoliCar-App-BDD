<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POLI-CAR - Gestionar Veh√≠culos</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container">
  <h1>POLI-CAR</h1>
  <h2>üöó Gestionar Veh√≠culos</h2>
  
  <!-- Controles superiores -->
  <div class="controles-superiores">
    <div class="busqueda-container">
      <input type="text" id="busquedaVehiculos" placeholder="üîç Buscar por matr√≠cula, marca, modelo o cliente...">
    </div>
    <div class="acciones-container">
      <button id="btnNuevoVehiculo" class="btn-nuevo">‚ûï Nuevo Veh√≠culo</button>
      <button id="btnRefrescar" class="btn-refrescar">üîÑ Refrescar</button>
    </div>
  </div>

  <!-- Mensaje de estado -->
  <p id="message"></p>

  <!-- Tabla de veh√≠culos -->
  <div id="vehiculosContainer">
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando veh√≠culos...</p>
    </div>
  </div>

  <!-- Modal para editar/crear veh√≠culo -->
  <div id="modalVehiculo" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Editar Veh√≠culo</h3>
        <span class="close">&times;</span>
      </div>
      <form id="formVehiculo">
        <div class="form-group">
          <label for="modalMatricula">Matr√≠cula:</label>
          <input type="text" id="modalMatricula" name="matricula" required>
        </div>
        <div class="form-group">
          <label for="modalCedulaCliente">C√©dula Cliente:</label>
          <input type="text" id="modalCedulaCliente" name="cedulaCliente" required>
          <div id="clientesSugeridos" class="sugerencias-container"></div>
          <small class="help-text">üí° Escribe para ver clientes disponibles</small>
        </div>
        <div class="form-group">
          <label for="modalMarca">Marca:</label>
          <input type="text" id="modalMarca" name="marca" required>
        </div>
        <div class="form-group">
          <label for="modalModelo">Modelo:</label>
          <input type="text" id="modalModelo" name="modelo" required>
        </div>
        <div class="form-group">
          <label for="modalFechaCompra">Fecha de Compra:</label>
          <input type="date" id="modalFechaCompra" name="fechaCompra">
        </div>
        <div class="form-group">
          <label for="modalAnio">A√±o:</label>
          <input type="number" id="modalAnio" name="anio" min="1900" max="2030">
        </div>
        <div class="modal-actions">
          <button type="button" id="btnCancelar" class="btn-cancelar">Cancelar</button>
          <button type="submit" id="btnGuardar" class="btn-guardar">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal de confirmaci√≥n para eliminar -->
  <div id="modalConfirmar" class="modal">
    <div class="modal-content modal-small">
      <div class="modal-header">
        <h3>Confirmar Eliminaci√≥n</h3>
        <span class="close-confirm">&times;</span>
      </div>
      <div class="modal-body">
        <p>¬øEst√° seguro que desea eliminar el veh√≠culo <strong id="vehiculoAEliminar"></strong>?</p>
        <p class="warning">‚ö†Ô∏è Esta acci√≥n no se puede deshacer.</p>
      </div>
      <div class="modal-actions">
        <button type="button" id="btnCancelarEliminar" class="btn-cancelar">Cancelar</button>
        <button type="button" id="btnConfirmarEliminar" class="btn-eliminar">Eliminar</button>
      </div>
    </div>
  </div>

  <div class="nav-links">
    <a href="dashboard.html">üè† Volver al Dashboard</a>
  </div>
</div>

<script src="js/main.js"></script>
<script>
// Variables globales
let vehiculosData = [];
let clientesData = [];
let editandoVehiculo = null;
let vehiculoAEliminar = null;

// Elementos del DOM
const vehiculosContainer = document.getElementById('vehiculosContainer');
const busquedaInput = document.getElementById('busquedaVehiculos');
const btnNuevoVehiculo = document.getElementById('btnNuevoVehiculo');
const btnRefrescar = document.getElementById('btnRefrescar');
const modalVehiculo = document.getElementById('modalVehiculo');
const modalConfirmar = document.getElementById('modalConfirmar');
const formVehiculo = document.getElementById('formVehiculo');
const modalTitle = document.getElementById('modalTitle');

// Event Listeners
document.addEventListener('DOMContentLoaded', () => {
  cargarVehiculos();
  cargarClientes();
  
  // B√∫squeda en tiempo real
  busquedaInput.addEventListener('input', filtrarVehiculos);
  
  // Autocompletado de clientes
  document.getElementById('modalCedulaCliente').addEventListener('input', mostrarSugerenciasClientes);
  document.getElementById('modalCedulaCliente').addEventListener('focus', mostrarSugerenciasClientes);
  document.getElementById('modalCedulaCliente').addEventListener('blur', () => {
    setTimeout(() => ocultarSugerenciasClientes(), 200);
  });
  
  // Botones principales
  btnNuevoVehiculo.addEventListener('click', abrirModalNuevo);
  btnRefrescar.addEventListener('click', cargarVehiculos);
  
  // Modal eventos
  document.querySelector('.close').addEventListener('click', cerrarModal);
  document.querySelector('.close-confirm').addEventListener('click', cerrarModalConfirmar);
  document.getElementById('btnCancelar').addEventListener('click', cerrarModal);
  document.getElementById('btnCancelarEliminar').addEventListener('click', cerrarModalConfirmar);
  
  // Form submit
  formVehiculo.addEventListener('submit', guardarVehiculo);
  
  // Confirmar eliminaci√≥n
  document.getElementById('btnConfirmarEliminar').addEventListener('click', confirmarEliminacion);
  
  // Cerrar modal al hacer click fuera
  window.addEventListener('click', (event) => {
    if (event.target === modalVehiculo) cerrarModal();
    if (event.target === modalConfirmar) cerrarModalConfirmar();
  });
});

// Cargar clientes desde el servidor
async function cargarClientes() {
  try {
    const response = await fetch('/api/clientes');
    const data = await response.json();
    
    if (data.success) {
      clientesData = data.data;
      console.log(`‚úÖ ${clientesData.length} clientes cargados`);
    } else {
      console.warn('‚ö†Ô∏è Error cargando clientes:', data.message);
    }
  } catch (error) {
    console.error('‚ùå Error cargando clientes:', error);
  }
}

// Mostrar sugerencias de clientes
function mostrarSugerenciasClientes() {
  const input = document.getElementById('modalCedulaCliente');
  const sugerenciasContainer = document.getElementById('clientesSugeridos');
  const termino = input.value.toLowerCase();
  
  if (!termino || clientesData.length === 0) {
    sugerenciasContainer.style.display = 'none';
    return;
  }
  
  const clientesFiltrados = clientesData.filter(cliente => 
    cliente.cedula.toLowerCase().includes(termino) ||
    cliente.nombre.toLowerCase().includes(termino) ||
    (cliente.apellido && cliente.apellido.toLowerCase().includes(termino))
  ).slice(0, 5); // Mostrar m√°ximo 5 sugerencias
  
  if (clientesFiltrados.length === 0) {
    sugerenciasContainer.style.display = 'none';
    return;
  }
  
  let html = '';
  clientesFiltrados.forEach(cliente => {
    html += `
      <div class="sugerencia-item" onclick="seleccionarCliente('${cliente.cedula}', '${cliente.nombre}', '${cliente.apellido || ''}')">
        <div class="sugerencia-cedula">${cliente.cedula}</div>
        <div class="sugerencia-nombre">${cliente.nombre} ${cliente.apellido || ''} - ${cliente.zona}</div>
      </div>
    `;
  });
  
  sugerenciasContainer.innerHTML = html;
  sugerenciasContainer.style.display = 'block';
}

// Seleccionar cliente de las sugerencias
function seleccionarCliente(cedula, nombre, apellido) {
  document.getElementById('modalCedulaCliente').value = cedula;
  ocultarSugerenciasClientes();
}

// Ocultar sugerencias
function ocultarSugerenciasClientes() {
  document.getElementById('clientesSugeridos').style.display = 'none';
}

// Cargar veh√≠culos desde el servidor
async function cargarVehiculos() {
  try {
    mostrarCargando();
    const response = await fetch('/api/vehiculos');
    const data = await response.json();
    
    if (data.success) {
      vehiculosData = data.data;
      mostrarVehiculos(vehiculosData);
      showMessage('message', data.message, true);
    } else {
      showMessage('message', data.message || 'Error al cargar veh√≠culos', false);
      vehiculosContainer.innerHTML = '<p class="error">Error al cargar veh√≠culos</p>';
    }
  } catch (error) {
    console.error('Error cargando veh√≠culos:', error);
    showMessage('message', 'Error de conexi√≥n al cargar veh√≠culos', false);
    vehiculosContainer.innerHTML = '<p class="error">Error de conexi√≥n</p>';
  }
}

// Mostrar veh√≠culos en la tabla
function mostrarVehiculos(vehiculos) {
  if (vehiculos.length === 0) {
    vehiculosContainer.innerHTML = '<p class="no-data">No hay veh√≠culos registrados</p>';
    return;
  }

  let html = `
    <div class="tabla-responsive">
      <table class="tabla-gestion">
        <thead>
          <tr>
            <th>Matr√≠cula</th>
            <th>Cliente</th>
            <th>Marca</th>
            <th>Modelo</th>
            <th>A√±o</th>
            <th>Fecha Compra</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
  `;
  
  vehiculos.forEach(vehiculo => {
    // Mejorar la visualizaci√≥n del cliente
    let nombreCliente;
    if (vehiculo.nombre_cliente) {
      nombreCliente = `${vehiculo.nombre_cliente} ${vehiculo.apellido_cliente || ''}`;
    } else if (vehiculo.cedula_cliente) {
      nombreCliente = `‚ö†Ô∏è ${vehiculo.cedula_cliente} (No registrado)`;
    } else {
      nombreCliente = '‚ùå Sin cliente';
    }
      
    const fechaCompra = vehiculo.fecha_compra 
      ? new Date(vehiculo.fecha_compra).toLocaleDateString('es-ES')
      : 'N/A';
    
    html += `
      <tr>
        <td><strong>${vehiculo.matricula}</strong></td>
        <td>${nombreCliente}</td>
        <td>${vehiculo.marca || 'N/A'}</td>
        <td>${vehiculo.modelo || 'N/A'}</td>
        <td>${vehiculo.anio || 'N/A'}</td>
        <td>${fechaCompra}</td>
        <td class="acciones">
          <button class="btn-editar" onclick="editarVehiculo('${vehiculo.matricula}')">‚úèÔ∏è Editar</button>
          <button class="btn-eliminar" onclick="eliminarVehiculo('${vehiculo.matricula}')">üóëÔ∏è Eliminar</button>
        </td>
      </tr>
    `;
  });
  
  html += `
        </tbody>
      </table>
    </div>
    <div class="tabla-info">
      <p>Total de veh√≠culos: <strong>${vehiculos.length}</strong></p>
    </div>
  `;
  
  vehiculosContainer.innerHTML = html;
}

// Filtrar veh√≠culos por b√∫squeda
function filtrarVehiculos() {
  const termino = busquedaInput.value.toLowerCase();
  
  if (!termino) {
    mostrarVehiculos(vehiculosData);
    return;
  }
  
  const vehiculosFiltrados = vehiculosData.filter(vehiculo => {
    const nombreCliente = `${vehiculo.nombre_cliente || ''} ${vehiculo.apellido_cliente || ''}`.toLowerCase();
    return (
      vehiculo.matricula.toLowerCase().includes(termino) ||
      vehiculo.marca?.toLowerCase().includes(termino) ||
      vehiculo.modelo?.toLowerCase().includes(termino) ||
      vehiculo.cedula_cliente?.toLowerCase().includes(termino) ||
      nombreCliente.includes(termino)
    );
  });
  
  mostrarVehiculos(vehiculosFiltrados);
}

// Abrir modal para nuevo veh√≠culo
function abrirModalNuevo() {
  editandoVehiculo = null;
  modalTitle.textContent = 'Nuevo Veh√≠culo';
  formVehiculo.reset();
  document.getElementById('modalMatricula').readOnly = false;
  modalVehiculo.style.display = 'block';
}

// Editar veh√≠culo
function editarVehiculo(matricula) {
  const vehiculo = vehiculosData.find(v => v.matricula === matricula);
  if (!vehiculo) return;
  
  editandoVehiculo = matricula;
  modalTitle.textContent = 'Editar Veh√≠culo';
  
  // Llenar el formulario
  document.getElementById('modalMatricula').value = vehiculo.matricula;
  document.getElementById('modalMatricula').readOnly = true;
  document.getElementById('modalCedulaCliente').value = vehiculo.cedula_cliente || '';
  document.getElementById('modalMarca').value = vehiculo.marca || '';
  document.getElementById('modalModelo').value = vehiculo.modelo || '';
  document.getElementById('modalAnio').value = vehiculo.anio || '';
  
  if (vehiculo.fecha_compra) {
    const fecha = new Date(vehiculo.fecha_compra);
    document.getElementById('modalFechaCompra').value = fecha.toISOString().split('T')[0];
  }
  
  modalVehiculo.style.display = 'block';
}

// Eliminar veh√≠culo
function eliminarVehiculo(matricula) {
  vehiculoAEliminar = matricula;
  document.getElementById('vehiculoAEliminar').textContent = matricula;
  modalConfirmar.style.display = 'block';
}

// Guardar veh√≠culo (crear o actualizar)
async function guardarVehiculo(event) {
  event.preventDefault();
  
  const formData = new FormData(formVehiculo);
  const vehiculoData = {
    matricula: formData.get('matricula'),
    cedulaCliente: formData.get('cedulaCliente'),
    marca: formData.get('marca'),
    modelo: formData.get('modelo'),
    fechaCompra: formData.get('fechaCompra') || null,
    anio: parseInt(formData.get('anio')) || null
  };
  
  try {
    let response;
    if (editandoVehiculo) {
      // Actualizar
      response = await fetch(`/api/vehiculos/${editandoVehiculo}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(vehiculoData)
      });
    } else {
      // Crear nuevo
      response = await fetch('/api/vehiculos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ciCliente: vehiculoData.cedulaCliente,
          matricula: vehiculoData.matricula,
          marca: vehiculoData.marca,
          modelo: vehiculoData.modelo,
          fechaCompra: vehiculoData.fechaCompra,
          anio: vehiculoData.anio
        })
      });
    }
    
    const data = await response.json();
    
    if (data.success) {
      showMessage('message', data.message, true);
      cerrarModal();
      cargarVehiculos();
    } else {
      showMessage('message', data.message || 'Error al guardar veh√≠culo', false);
    }
  } catch (error) {
    console.error('Error guardando veh√≠culo:', error);
    showMessage('message', 'Error de conexi√≥n al guardar veh√≠culo', false);
  }
}

// Confirmar eliminaci√≥n
async function confirmarEliminacion() {
  if (!vehiculoAEliminar) return;
  
  try {
    const response = await fetch(`/api/vehiculos/${vehiculoAEliminar}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      showMessage('message', data.message, true);
      cerrarModalConfirmar();
      cargarVehiculos();
    } else {
      showMessage('message', data.message || 'Error al eliminar veh√≠culo', false);
    }
  } catch (error) {
    console.error('Error eliminando veh√≠culo:', error);
    showMessage('message', 'Error de conexi√≥n al eliminar veh√≠culo', false);
  }
}

// Cerrar modales
function cerrarModal() {
  modalVehiculo.style.display = 'none';
  editandoVehiculo = null;
  formVehiculo.reset();
}

function cerrarModalConfirmar() {
  modalConfirmar.style.display = 'none';
  vehiculoAEliminar = null;
}

// Mostrar estado de carga
function mostrarCargando() {
  vehiculosContainer.innerHTML = `
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando veh√≠culos...</p>
    </div>
  `;
}
</script>
</body>
</html>
